{% extends 'TreeFinder/base.html' %}

{% block content %}

  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

      <form id="filter_form" method="post" action="/filter/">

    {% csrf_token %}
            {% for field in form.visible_fields %}
                {{ field }}
            {% endfor %}

            <input id="filterButton" type="submit" name="submit" value="Find Trees" />
        </form>

{% if user.is_authenticated %}
    <h1>TreeFinder says... hello {{ user.username }}!</h1>
    <a href="/logout/">Logout</a><br />
{% else %}
    <h1>TreeFinder says... hello world!</h1>
    <a href="/register/">Register Here</a><br />
    <a href="/login/">Login</a><br />
{% endif %}

    <title>Places search box</title>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>
    <script>
// This example adds a search box to a map, using the Google Place Autocomplete
// feature. People can enter geographical searches. The search box will return a
// pick list containing a mix of places and predicted search terms.
var map;


    function initializeTree(tree) {
      var latitude = tree.x_coordinate;
      var longitude = tree.y_coordinate;
        console.log(latitude + ", " + longitude);
        var latlng = new google.maps.LatLng(latitude,longitude);
        var marker = new google.maps.Marker({
          position: latlng,
          map: map,
            title:"its a tree"
        });

          var contentString = '<div id="content">'+
      '<table border="1">' +
        '<tr>' +
          '<td>Species: </td>' +
          '<td>'+tree.species+'</td>' +
        '</tr>'  +
        '<tr>' +
          '<td>Address: </td>' +
          '<td>'+tree.civicNumber+' '+tree.onStreet+'</td>' +
        '</tr>'  +
        '<tr>' +
          '<td>Neighbourhood: </td>' +
          '<td>'+tree.neighbourhoodName+'</td>' +
        '</tr>'  +
      '</table>' +
      '</div>';

      //  var contentString = '<div id="content">'+
      // '<div id="siteNotice">'+ tree.species + 
      // '</div>'+
      // '<h1 id="firstHeading" class="firstHeading">Uluru</h1>'+
      // '<div id="bodyContent">'+
      // '<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large ' +
      // 'sandstone rock formation in the southern part of the '+
      // 'Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) '+
      // 'south west of the nearest large town, Alice Springs; 450&#160;km '+
      // '(280&#160;mi) by road. Kata Tjuta and Uluru are the two major '+
      // 'features of the Uluru - Kata Tjuta National Park. Uluru is '+
      // 'sacred to the Pitjantjatjara and Yankunytjatjara, the '+
      // 'Aboriginal people of the area. It has many springs, waterholes, '+
      // 'rock caves and ancient paintings. Uluru is listed as a World '+
      // 'Heritage Site.</p>'+
      // '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">'+
      // 'https://en.wikipedia.org/w/index.php?title=Uluru</a> '+
      // '(last visited June 22, 2009).</p>'+
      // '</div>'+
      // '</div>';


  var infowindow = new google.maps.InfoWindow({
      content: contentString
  });
  google.maps.event.addListener(infowindow,'domready',function(){
    var myDiv = document.createElement('button');
    myDiv.id = 'saveButton';
    myDiv.value = "testing";
{#    myDiv.style.height#}

    myDiv.onclick = function(){
        console.log("save button clicked");
    }
    var parentNode = document.getElementById('content');
    if (!parentNode.contains(myDiv)) {
        console.log("PASS");
       parentNode.appendChild(myDiv);
    }
  });
    google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map,marker);
  });
    }

      function markTrees() {
          var treesListJson = '{{ Trees|safe }}';
          var allTrees = JSON.parse(treesListJson);
            for (i=0; i<allTrees.length; i++) {
              console.log("CREATING MARKER");
              var tree = allTrees[i].fields;
              // initializeTree(tree.x_coordinate, tree.y_coordinate);
              initializeTree(tree);
            }
      }



function initialize() {

  var markers = [];
  map = new google.maps.Map(document.getElementById('map-canvas'), {
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });

  var defaultBounds = new google.maps.LatLngBounds(
      new google.maps.LatLng(49.2721, -123.2552),
          new google.maps.LatLng(49.2061, -123.0503));

  map.fitBounds(defaultBounds);

  // Create the search box and link it to the UI element.
  var input = /** @type {HTMLInputElement} */(
      document.getElementById('pac-input'));
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

  var searchBox = new google.maps.places.SearchBox(
    /** @type {HTMLInputElement} */(input));

  // [START region_getplaces]
  // Listen for the event fired when the user selects an item from the
  // pick list. Retrieve the matching places for that item.
  google.maps.event.addListener(searchBox, 'places_changed', function() {
    var places = searchBox.getPlaces();

    if (places.length == 0) {
      return;
    }
    for (var i = 0, marker; marker = markers[i]; i++) {
      marker.setMap(null);
    }

    // For each place, get the icon, place name, and location.
    markers = [];
    var bounds = new google.maps.LatLngBounds();
    for (var i = 0, place; place = places[i]; i++) {
      var image = {
        url: place.icon,
        size: new google.maps.Size(71, 71),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(17, 34),
        scaledSize: new google.maps.Size(25, 25)
      };

      // Create a marker for each place.
      var marker = new google.maps.Marker({
        map: map,
        icon: image,
        title: place.name,
        position: place.geometry.location
      });

      markers.push(marker);
      bounds.extend(place.geometry.location);
    }
    map.fitBounds(bounds);
  });
  // [END region_getplaces]

  // Bias the SearchBox results towards places that are within the bounds of the
  // current map's viewport.
  google.maps.event.addListener(map, 'bounds_changed', function() {
    var bounds = map.getBounds();
    searchBox.setBounds(bounds);
  });
    //markTrees(map);
    markTrees();
}

google.maps.event.addDomListener(window, 'load', initialize);

        markTrees(map);
    </script>
    <style>
      #target {
        width: 345px;
      }
    </style>
  </head>
  <body>
    <input id="pac-input" class="controls" type="text" placeholder="Find Trees Near Address">
    <div id="map-canvas"></div>
  </body>

</html>
{% endblock %}